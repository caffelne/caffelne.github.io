<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ã€Heap.01ã€‘å †åˆ©ç”¨å­¦ä¹ ç¬”è®° | uuu</title><meta name="keywords" content="å †"><meta name="author" content="uuu"><meta name="copyright" content="uuu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Be brave. The world is our oyster.">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€Heap.01ã€‘å †åˆ©ç”¨å­¦ä¹ ç¬”è®°">
<meta property="og:url" content="http://caffelne.github.io/posts/53983.html">
<meta property="og:site_name" content="uuu">
<meta property="og:description" content="Be brave. The world is our oyster.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/pwn_1@Lifeline.jpg">
<meta property="article:published_time" content="2022-03-05T13:47:48.000Z">
<meta property="article:modified_time" content="2022-05-24T08:45:59.999Z">
<meta property="article:author" content="uuu">
<meta property="article:tag" content="å †">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/pwn_1@Lifeline.jpg"><link rel="shortcut icon" href="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/uuu.jpg"><link rel="canonical" href="http://caffelne.github.io/posts/53983"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ã€Heap.01ã€‘å †åˆ©ç”¨å­¦ä¹ ç¬”è®°',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-24 16:45:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/caffe1ne.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/pwn_1@Lifeline.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">uuu</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ã€Heap.01ã€‘å †åˆ©ç”¨å­¦ä¹ ç¬”è®°</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-03-05T13:47:48.000Z" title="å‘è¡¨äº 2022-03-05 21:47:48">2022-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-05-24T08:45:59.999Z" title="æ›´æ–°äº 2022-05-24 16:45:59">2022-05-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/Pwn/">Pwn</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/Pwn/%E5%A0%86/">å †</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ã€Heap.01ã€‘å †åˆ©ç”¨å­¦ä¹ ç¬”è®°"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote><p>çŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>
</blockquote>	
<p>â€‹	Pwn çš„å…¥é—¨å¯¹æˆ‘æ¥è¯´å±å®è‰°éš¾ï¼Œä¸€è·¯è·Ÿç€å„ä½äºŒè¿›åˆ¶ <span class="emoji" alias="older_man" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f474.png?v8">ğŸ‘´</span> çš„åšå®¢æ–‡ç« å­¦ä¹ å­¦åˆ°äº†å¥½å¤šå¥½ä¸œè¥¿ã€‚è¿™é‡Œåšç‚¹é›¶ç¢çš„å­¦ä¹ è®°å½•ï¼Œå¦‚å‘ç°é”™è¯¯ï¼Œè¿˜è¯·å„ä½ <span class="emoji" alias="older_man" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f474.png?v8">ğŸ‘´</span> ä¸åèµæ•™ã€‚</p>
<p>â€‹	äº‹å®è¯æ˜è¿™ç©æ„ä¸æ˜¯æˆ‘ä»¥ä¸ºæˆ‘ä¼šäº†å°±ä¼šäº†<span class="emoji" alias="anger" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a2.png?v8">ğŸ’¢</span>ï¼Œä¸å¸¦è„‘å­åœ°çœ‹æºç æŠŠè‡ªå·±çœ‹é£˜äº†ï¼Œæ¯ç§ attack éƒ½è¦è¿›è¡Œç›¸å…³ç»ƒä¹ ã€‚</p>
<p>â€‹	<em><strong>2022/5/9</strong></em>: <span class="emoji" alias="dove" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f54a.png?v8">ğŸ•Š</span> è¿™é‡Œå†™çš„ä¸œè¥¿å¹¶ä¸å…¨ï¼Œåªèƒ½è¯´æ˜¯è®°å½•ä¸‹åˆšå­¦çš„æ—¶å€™ç¢°åˆ°çš„ä¸œè¥¿ã€‚è¿™ç©æ„æˆ‘è§‰å¾—æˆ‘æ˜¯å†™ä¸å®Œçš„ï¼Œåªèƒ½è¯´å†™ç‚¹æ˜¯ç‚¹å§ã€‚</p>
<h1>Attack</h1>
<h2 id="Off-by-one">Off by one</h2>
<p><strong>Off by one</strong>ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æº¢å‡ºä¸€ä¸ªå­—èŠ‚ã€‚å½“æº¢å‡ºå­—èŠ‚ä¸ºå…³é”®ä½ç½®çš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡Œä¸€æ³¢ç¨‹åºçš„ <span class="emoji" alias="sheep" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8">ğŸ‘</span> ã€‚</p>
<h3 id="åˆ©ç”¨æ€è·¯">åˆ©ç”¨æ€è·¯</h3>
<ol>
<li>æ‰“å †é‡å ï¼Œä»è€Œæ³„éœ²å…¶ä»–å—æ•°æ®ï¼Œæˆ–æ˜¯è¦†ç›–å…¶ä»–å—æ•°æ®ã€‚ä¹Ÿå¯ä½¿ç”¨ NULL å­—èŠ‚æº¢å‡ºçš„æ–¹æ³•(<strong>Off by NULL</strong>)</li>
<li>æº¢å‡ºå­—èŠ‚ä¸º NULL å­—èŠ‚ï¼šåœ¨ size ä¸º 0x100 çš„æ—¶å€™ï¼Œæº¢å‡º NULL å­—èŠ‚å¯ä»¥ä½¿å¾— <code>prev_in_use</code> ä½è¢«æ¸…ï¼Œè¿™æ ·å‰å—ä¼šè¢«è®¤ä¸ºæ˜¯ free å—ã€‚ï¼ˆ1ï¼‰ æ‰“ unlink ã€‚ï¼ˆ2ï¼‰ å¦å¤–ï¼Œè¿™æ—¶ <code>prev_size</code> åŸŸå°±ä¼šå¯ç”¨ï¼Œå°±å¯ä»¥ä¼ªé€  <code>prev_size</code> ï¼Œæ‰“å †é‡å ã€‚unlink æ–¹æ³•çš„å…³é”®åœ¨äº unlink çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥æŒ‰ç…§ <code>prev_size</code> æ‰¾åˆ°çš„å—çš„å¤§å°ä¸<code>prev_size</code> æ˜¯å¦ä¸€è‡´ã€‚</li>
</ol>
<h3 id="å¸¸è§æ¼æ´">å¸¸è§æ¼æ´</h3>
<ol>
<li>å¾ªç¯æ¬¡æ•°ä¸åˆç†</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_gets</span><span class="params">(<span class="keyword">char</span> *ptr,<span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr[i]=getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *chunk1,*chunk2;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    chunk2=<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input:&quot;</span>);</span><br><span class="line">    my_gets(chunk1,<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸º <strong>i&lt;=size</strong> çš„é”™è¯¯å†™æ³•ï¼Œä½¿å¾—å®é™…è¯»å…¥çš„æ•°æ®ä¼šæ¯” size å¤šä¸€ä½ã€‚</p>
<ol start="2">
<li>å‡½æ•°è¡Œä¸ºä¸ä¸€è‡´</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">40</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">void</span> *chunk1;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">24</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input&quot;</span>);</span><br><span class="line">    gets(buffer);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(buffer)==<span class="number">24</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(chunk1,buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸º <strong>strlen()</strong> å‡½æ•°è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ä¸æŠŠ <strong>\x00</strong> è®¡ç®—åœ¨å†…ï¼Œä½†æ˜¯ <strong>strcpy()</strong> åœ¨å¤åˆ¶å­—ç¬¦ä¸²çš„æ—¶å€™ä¼šæ‹·è´ <strong>\x00</strong> ï¼Œé€ æˆ <strong>Off by NULL</strong> æ¼æ´ã€‚</p>
<h3 id="ç›¸å…³é¢˜ç›®è®°å½•">ç›¸å…³é¢˜ç›®è®°å½•</h3>
<p>Off by one:</p>
<p><a target="_blank" rel="noopener" href="https://caffeine.darkflow.top/posts/21b97b6b.html#%E5%90%83%E9%B8%A1%E6%9D%AF-ezheap">CTFshow - ezheap</a></p>
<hr>
<h2 id="Chunk-Extend-and-Overlapping">Chunk Extend and Overlapping</h2>
<p>å †å—æ‰©å±•ä¸é‡å </p>
<h3 id="æ³¨æ„-2">æ³¨æ„</h3>
<p>éœ€è¦å­˜åœ¨æ§åˆ¶ chunk å¤´ size çš„æ¼æ´(å¦‚ <strong>off by one</strong>ç­‰)ã€‚</p>
<p><strong>Off by NULL</strong> åˆ™ä¸€èˆ¬è€ƒè™‘ <code>malloc(0xf8)</code>ï¼Œè¿™æ ·è¦†ç›–æ‰ <code>0x101</code> å¯ä»¥è¦†ç›–æ‰ prev_inuse ä½ã€‚</p>
<p>åœ¨ <strong>libc 2.29</strong> åŠ å…¥äº†ç›¸å…³çš„æ£€æŸ¥æœºåˆ¶ã€‚</p>
<h3 id="æ•ˆæœ">æ•ˆæœ</h3>
<ol>
<li>æ‹¿ä¸€ä¸ªæ›´å¤§çš„å †å—ä¸é¦™å—</li>
<li>æ‹¿ä¸€ä¸ªå¸¦æœ‰å…³é”®æŒ‡é’ˆçš„å †å—ä¸é¦™å—</li>
</ol>
<h3 id="åŸç†-3">åŸç†</h3>
<p>chunk extend æŠ€æœ¯èƒ½å¤Ÿäº§ç”Ÿçš„åŸå› åœ¨äº ptmalloc åœ¨å¯¹å † chunk è¿›è¡Œæ“ä½œæ—¶ä½¿ç”¨çš„å„ç§å®ã€‚è€Œè¿™äº›å®å®ƒä»¬æ˜¯<em><strong>ä»¥ chunk å¤´éƒ¨çš„ size ä½æ¥ç¡®å®šå‰åå †å—ä»¥åŠç›¸å…³ä¿¡æ¯</strong></em>ï¼Œè¿™å°±äº§ç”Ÿäº†åˆ©ç”¨ç©ºé—´ã€‚</p>
<p>chunk overlap æ˜¯å¾—åˆ°åŒ…å«ä¸€ä¸ªå° chunk çš„å¤§ chunk çš„ä¸€ç§æ”»å‡»æ‰‹æ®µï¼Œä¹‹åå¯ä»¥ free æ‰å° chunk ï¼Œä»è€Œé€šè¿‡ç¨‹åºæä¾›çš„ç›¸å…³åŠŸèƒ½ï¼Œè¾¾åˆ°æ³„éœ²(<strong>show</strong>)ç”šè‡³ä¿®æ”¹(<strong>edit</strong>)ç›¸å…³æŒ‡é’ˆçš„æ•ˆæœã€‚</p>
<p>åœ¨ ptmalloc ä¸­ï¼Œè·å– chunk å—å¤§å°çš„æ“ä½œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize_nomask(p) ((p)-&gt;mchunk_size)</span></span><br></pre></td></tr></table></figure>
<p>ä¸€ç§æ˜¯ç›´æ¥è·å– chunk çš„å¤§å°ï¼Œä¸å¿½ç•¥æ©ç éƒ¨åˆ†ï¼Œå¦å¤–ä¸€ç§æ˜¯å¿½ç•¥æ©ç éƒ¨åˆ†ã€‚</p>
<p>åœ¨ ptmalloc ä¸­ï¼Œè·å–ä¸‹ä¸€ chunk å—åœ°å€çš„æ“ä½œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Ptr to next physical malloc_chunk. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> next_chunk(p) ((mchunkptr)(((char *) (p)) + chunksize(p)))</span></span><br></pre></td></tr></table></figure>
<p>å³ä½¿ç”¨å½“å‰å—æŒ‡é’ˆåŠ ä¸Šå½“å‰å—å¤§å°ã€‚</p>
<p>åœ¨ ptmalloc ä¸­ï¼Œè·å–å‰ä¸€ä¸ª chunk ä¿¡æ¯çš„æ“ä½œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Size of the chunk below P.  Only valid if prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ptr to previous physical malloc_chunk.  Only valid if prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_chunk(p) ((mchunkptr)(((char *) (p)) - prev_size(p)))</span></span><br></pre></td></tr></table></figure>
<p>å³é€šè¿‡ malloc_chunk-&gt;prev_size è·å–å‰ä¸€å—å¤§å°ï¼Œç„¶åä½¿ç”¨æœ¬ chunk åœ°å€å‡å»æ‰€å¾—å¤§å°ã€‚</p>
<p>åœ¨ ptmallocï¼Œåˆ¤æ–­å½“å‰ chunk æ˜¯å¦æ˜¯ use çŠ¶æ€çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inuse(p)</span></span><br><span class="line">    ((((mchunkptr)(((<span class="keyword">char</span> *) (p)) + chunksize(p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span><br></pre></td></tr></table></figure>
<p>å³æŸ¥çœ‹ä¸‹ä¸€ chunk çš„ prev_inuse åŸŸï¼Œè€Œä¸‹ä¸€å—åœ°å€åˆå¦‚æˆ‘ä»¬å‰é¢æ‰€è¿°æ˜¯æ ¹æ®å½“å‰ chunk çš„ size è®¡ç®—å¾—å‡ºçš„ã€‚</p>
<h3 id="åˆ©ç”¨ç¤ºä¾‹-libc-2-23ä¸‹-ï¼Œlibc-2-27-åˆ™å…ˆå¤„ç†-Tcache">åˆ©ç”¨ç¤ºä¾‹(libc 2.23ä¸‹ ï¼Œlibc 2.27 åˆ™å…ˆå¤„ç† Tcache)</h3>
<ol>
<li>å‘é«˜åœ°å€è¿›è¡Œæ“ä½œ</li>
</ol>
<p>ç›¸å½“å¥½ç†è§£ï¼Œæ¯”è¾ƒå®¹æ˜“æŒæ¡ã€‚**æ”¹å¤§ chunk çš„ sizeï¼Œfree åå†æ‹¿å‡ºæ¥å°±å˜å¤§äº†ã€‚**æ³¨æ„ç»•ä¸€ä¸‹ prev_inuse çš„æ£€æŸ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *ptr,*ptr1;</span><br><span class="line">	<span class="comment">// æ³¨æ„ ptr æŒ‡å‘çš„æ˜¯ chunk 1 çš„ user åŒºåŸŸ(ä¸å« chunk å¤´)</span></span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);	<span class="comment">//chunk 1	Chunk size:0x20</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);	<span class="comment">//chunk 2	Chunk size:0x20</span></span><br><span class="line">	<span class="comment">// åœ¨å¯»æ‰¾ chunk 1 çš„é«˜åœ°å€ chunk æ—¶ä¼šæ‰¾åˆ° chunk 1 å¤´ + 0x40</span></span><br><span class="line">    *(<span class="keyword">long</span> <span class="keyword">long</span> *)((<span class="keyword">long</span> <span class="keyword">long</span>)ptr<span class="number">-0x8</span>)=<span class="number">0x41</span>;	<span class="comment">// ä¿®æ”¹ç¬¬ä¸€ä¸ªå—çš„sizeåŸŸ</span></span><br><span class="line">	<span class="comment">// è¿™é‡Œè¦ä¿è¯ chunk 1 å¤´ + 0x40 å¤„çš„ chunk çš„ prev_inuse ä½ä¸º 1</span></span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    ptr1=<span class="built_in">malloc</span>(<span class="number">0x30</span>);	<span class="comment">// å®ç° extendï¼Œæ§åˆ¶äº†ç¬¬äºŒä¸ªå—çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>å‘ä½åœ°å€è¿›è¡Œæ“ä½œ</li>
</ol>
<p>å½“ free ä¸€ä¸ªä¸å±äº fastbin èŒƒå›´çš„ chunk æ—¶ï¼Œä¼šå…ˆå‘ä½åœ°å€åˆ¤æ–­æ˜¯å¦åˆå¹¶ï¼Œä¹‹åå‘é«˜åœ°å€åˆ¤æ–­æ˜¯å¦åˆå¹¶ã€‚</p>
<p>è¿™é‡Œå®é™…åŸç†æ¯”è¾ƒå¤æ‚ï¼Œåˆ†æ­¥è§£é‡Šä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *ptr1,*ptr2,*ptr3,*ptr4;</span><br><span class="line">    ptr1=<span class="built_in">malloc</span>(<span class="number">0x80</span>);<span class="comment">//smallbin1	Chunk size:0x90</span></span><br><span class="line">    ptr2=<span class="built_in">malloc</span>(<span class="number">0x10</span>);<span class="comment">//fastbin1	Chunk size:0x20</span></span><br><span class="line">    ptr3=<span class="built_in">malloc</span>(<span class="number">0x10</span>);<span class="comment">//fastbin2	Chunk size:0x20</span></span><br><span class="line">    ptr4=<span class="built_in">malloc</span>(<span class="number">0x80</span>);<span class="comment">//smallbin2	Chunk size:0x90</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);<span class="comment">//é˜²æ­¢ä¸topåˆå¹¶</span></span><br><span class="line">    <span class="comment">//æˆ‘ä»¬è¿™é‡Œ free æ‰äº† smallbin1 ï¼Œsmallbin1 ä¼šå…ˆè¿›å…¥åˆ° unsorbin é‡Œï¼Œå½¢æˆåŒå‘é“¾è¡¨ï¼Œç»•è¿‡ unlink æ£€æŸ¥</span></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="comment">// æ ‡è®°ä¸Šä¸ªå †å—å¤„äº free çŠ¶æ€</span></span><br><span class="line">    *(<span class="keyword">int</span> *)((<span class="keyword">long</span> <span class="keyword">long</span>)ptr4<span class="number">-0x8</span>)=<span class="number">0x90</span>;		<span class="comment">//ä¿®æ”¹pre_inuseåŸŸ	</span></span><br><span class="line">    <span class="comment">// å¾€ä½åœ°å€æŸ¥æ‰¾ chunk æ—¶ä¼šæ‰¾åˆ° smallbin1</span></span><br><span class="line">    *(<span class="keyword">int</span> *)((<span class="keyword">long</span> <span class="keyword">long</span>)ptr4<span class="number">-0x10</span>)=<span class="number">0xd0</span>;	<span class="comment">//ä¿®æ”¹pre_sizeåŸŸ	0xd0 = 13 * 0x10 = 0x90 + 0x20 + 0x20</span></span><br><span class="line">    <span class="built_in">free</span>(ptr4);	<span class="comment">// è§¦å‘ unlink</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x150</span>);	<span class="comment">// å–å‡ºåˆå¹¶åçš„å— Chunk size:0x150 = 22 * 0x10 = 0x90 + 0x20 + 0x20 + 0x90</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç›¸å…³ä»£ç ">ç›¸å…³ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="comment">// p ä¸ºè¢« free çš„ chunkï¼Œä¸Šé¢çš„ä¾‹å­é‡Œæ˜¯ smallbin2</span></span><br><span class="line">   <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">       <span class="comment">// prevsize ä¸º chunk p çš„ prev_size ä½å¡«å†™çš„æ•°æ®ï¼Œä¾‹å­ä¸­æˆ‘ä»¬æŠŠå®ƒæ‰¬æˆäº† 0</span></span><br><span class="line">     prevsize = prev_size (p);</span><br><span class="line">       <span class="comment">// size å¢åŠ å¯¹åº”çš„å¤§å°ï¼Œåé¢ set çš„æ—¶å€™è¦ç”¨åˆ° size å®šä½</span></span><br><span class="line">     size += prevsize;</span><br><span class="line">       <span class="comment">// é€šè¿‡ -prevsize æ‰¾åˆ°ä½åœ°å€çš„ chunk</span></span><br><span class="line">     p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">       <span class="comment">// æ‰§è¡Œ unlink æ“ä½œ</span></span><br><span class="line">     unlink(av, p, bck, fwd);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜åœ°å€çš„ä¸‹ä¸€ä¸ª chunk ä¸æ˜¯ topchunk çš„è¯ï¼Œå°†å®ƒçš„ prev_inuse ä½è®¾ä¸º 0</span></span><br><span class="line">   <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">     <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">     nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* consolidate forward */</span></span><br><span class="line">     <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">unlink(av, nextchunk, bck, fwd);</span><br><span class="line">size += nextsize;</span><br><span class="line">     &#125; <span class="keyword">else</span></span><br><span class="line">clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">       <span class="comment">/* unsortedbin å…¥é“¾æ“ä½œ*/</span></span><br><span class="line">       <span class="comment">// bck æ˜¯ unsortedbin é“¾è¡¨å¤´</span></span><br><span class="line">     bck = unsorted_chunks(av);</span><br><span class="line">       <span class="comment">// fwd æ˜¯ unsorted æœ€è¿‘åŠ å…¥çš„ chunk</span></span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line">       <span class="comment">// é“¾è¡¨ä¸ºç©ºåˆ™æŠ¥é”™</span></span><br><span class="line">     <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">malloc_printerr (<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">       <span class="comment">// p å˜ä¸ºæœ€è¿‘åŠ å…¥çš„ chunkï¼Œfd æŒ‡å‘å…ˆå‰è¿™ä¸ªä½ç½®çš„ chunkï¼ŒbkæŒ‡å‘é“¾è¡¨å¤´</span></span><br><span class="line">     p-&gt;fd = fwd;</span><br><span class="line">     p-&gt;bk = bck;</span><br><span class="line">       <span class="comment">// å¦‚æœä¸å±äº smallbin èŒƒå›´ï¼Œè¿˜è¦æŠŠ size ç›¸å…³æŒ‡é’ˆç½®ç©º</span></span><br><span class="line">     <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">&#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">       <span class="comment">// p å˜ä¸ºæœ€è¿‘åŠ å…¥çš„ chunkï¼Œé“¾è¡¨å¤´çš„ fd æŒ‡å‘å®ƒ</span></span><br><span class="line">     bck-&gt;fd = p;</span><br><span class="line">       <span class="comment">// åŸå…ˆçš„ chunk ç°åœ¨å˜æˆ æ¬¡ æœ€è¿‘åŠ å…¥çš„ chunk äº†ï¼Œbk æŒ‡å‘æœ€è¿‘åŠ å…¥çš„ chunk</span></span><br><span class="line">     fwd-&gt;bk = p;</span><br><span class="line">       <span class="comment">// è®¾ç½® chunk p çš„ size å’Œ prev_inuse ä½</span></span><br><span class="line">     set_head(p, size | PREV_INUSE);</span><br><span class="line">       <span class="comment">// ä¿®æ”¹ chunk p ä¸‹ä¸€ä¸ª chunk çš„ prev_size ä½</span></span><br><span class="line">     set_foot(p, size);</span><br><span class="line"></span><br><span class="line">     check_free_chunk(av, p);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæœ€åæˆ‘ä»¬å°±èƒ½åœ¨ unsortedbin ä¸­æ‰¾åˆ°ä» smallbin1å¤´ ä¸€ç›´åˆ° smallbin2 æœ«å°¾çš„è¶…å¤§ chunk ï¼Œå°±å¯ä»¥æ„‰å¿«çš„æäº‹æƒ…äº†ã€‚</p>
<h3 id="unlink-ç»•è¿‡åŸç†">unlink ç»•è¿‡åŸç†</h3>
<p>å…¶ä¸­ï¼Œå‘ä½åœ°å€åˆå¹¶æ—¶ unlink éƒ¨åˆ†å­˜åœ¨ç›¸å…³æ£€æµ‹ï¼Œå…·ä½“åœ¨ä¸‹é¢çš„ unlink éƒ¨åˆ†æœ‰å†™å‡ºï¼ˆä¸è¿‡ä¸‹é¢ä»‹ç»çš„æ˜¯å¦ä¸€ç§æ”»å‡»æ–¹å¼ï¼‰ã€‚è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹æ‰§è¡Œ unlink çš„ chunk å±äº smallbin èŒƒå›´æ—¶çš„ç›¸å…³æ£€æŸ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unlink(AV, P, BK, FD) &#123;</span></span><br><span class="line">...</span><br><span class="line">  <span class="comment">// 1.è¢« unlink çš„ chunk å¤§å°è¦å’Œä¸‹ä¸€ä¸ª chunk çš„ prev_size ç›¸åŒ</span></span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line">  <span class="comment">// 2.å¯¹ fd å’Œ bk çš„æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure>
<p>åœ¨æˆ‘ä»¬æ²¡æœ‰å¯¹ nextchunk ä¹Ÿå°±æ˜¯é«˜åœ°å€çš„ chunk è¿›è¡Œä¹±æçš„æƒ…å†µä¸‹ï¼Œæ£€æŸ¥ 1 æ˜¯ä¸ç”¨æƒ³åŠæ³•å»ç»•è¿‡çš„ã€‚</p>
<p>è€Œæˆ‘ä»¬æ—©æ—©å°±æŠŠ smallbin1 ä¸¢å…¥äº† <strong>unsortedbin</strong> é‡Œé¢ï¼Œæ³¨æ„è¿™æ—¶ unsortedbin é‡Œé¢åªæœ‰ smallbin ä¸€ä¸ª chunkï¼Œé‚£ä¹ˆ smallbin1 çš„ fd å’Œ bk æŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘ unsortedbin çš„é“¾è¡¨å¤´ï¼Œé“¾è¡¨å¤´çš„ fd å’Œ bkåˆéƒ½æ˜¯æŒ‡å‘ smallbin1ã€‚ ä¹Ÿå°±å¾ˆå·§å¦™åœ°ç»•è¿‡äº†æ£€æŸ¥ 2ã€‚</p>
<h3 id="libc-2-29-æ£€æµ‹ä»£ç ">libc 2.29 æ£€æµ‹ä»£ç </h3>
<p>ä¸ºæ–¹ä¾¿ç»§ç»­æ²¿ç”¨ä¸Šé¢çš„ä¾‹å­è¯´æ˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="comment">// p ä¸º smallbin2</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">    <span class="comment">// è¿™é‡Œ p å–åˆ°äº† smallbin1</span></span><br><span class="line">  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    <span class="comment">// smallbin1 çš„å¤§å°å’Œæˆ‘ä»¬æ„é€ çš„ prevsize è‚¯å®šæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯•ç«Ÿæˆ‘ä»¬è¦æ‰©å¤§æ§åˆ¶çš„ chunk å¤§å°ï¼Œäºæ˜¯æŠ¥é”™</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">    </span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;	</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶æˆ‘ä»¬åŸå…ˆçš„åˆ©ç”¨æ–¹æ³•å°±å¤±æ•ˆäº†ï¼Œä¾¿éœ€è¦ä½¿ç”¨æ–°çš„æ”»å‡»æ–¹æ³•ã€‚</p>
<p>å¾…å¡«å‘</p>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://surager.pub/_posts/2020-05-24-%E5%85%B3%E4%BA%8Elibc2.29%E4%B8%AD%E7%9A%84off-by-null/">å…³äºlibc2.29ä¸­çš„off-by-null - surager</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-257901.htm">glibc2.29ä¸‹çš„off-by-null - t1an5g</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.eonew.cn/2019-08-02.Glibc-2.29%20%E6%96%B0%E5%A2%9E%E7%9A%84%E9%98%B2%E6%8A%A4%E6%9C%BA%E5%88%B6.html">Glibc-2.29 æ–°å¢çš„é˜²æŠ¤æœºåˆ¶ - Ex</a></p>
<hr>
<h2 id="Unsortedbin-Attack-libc-2-28">Unsortedbin Attack(&lt; libc 2.28)</h2>
<p>how2heapä¸Šçš„æè¿°æ˜¯&lt;libc-2.29ã€‚ä½†æœ‰å¸ˆå‚…å®æµ‹è¯¥è¡¥ä¸å·²ç»ç»™åˆ°äº†glibc2.27-3ubuntu1.4</p>
<p>åœ¨ä»‹ç» Unsortedbin æ”»å‡»å‰ï¼Œå¯ä»¥å…ˆå›é¡¾ä¸€ä¸‹ Unsorted Bin çš„åŸºæœ¬æ¥æºä»¥åŠåŸºæœ¬ä½¿ç”¨æƒ…å†µã€‚</p>
<h3 id="åŸºæœ¬æ¥æº">åŸºæœ¬æ¥æº</h3>
<ol>
<li>å½“ä¸€ä¸ªè¾ƒå¤§çš„ chunk è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚</li>
<li>é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­ã€‚å…³äº top chunk çš„è§£é‡Šï¼Œè¯·å‚è€ƒä¸‹é¢çš„ä»‹ç»ã€‚</li>
<li>å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯ã€‚</li>
</ol>
<h3 id="åŸºæœ¬ä½¿ç”¨æƒ…å†µ">åŸºæœ¬ä½¿ç”¨æƒ…å†µ</h3>
<ol>
<li>Unsorted Bin åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨çš„éå†é¡ºåºæ˜¯ FIFOï¼Œ<strong>å³æ’å…¥çš„æ—¶å€™æ’å…¥åˆ° unsorted bin çš„å¤´éƒ¨ï¼Œå–å‡ºçš„æ—¶å€™ä»é“¾è¡¨å°¾è·å–</strong>ã€‚</li>
<li>åœ¨ç¨‹åº malloc æ—¶ï¼Œå¦‚æœåœ¨ fastbinï¼Œsmall bin ä¸­æ‰¾ä¸åˆ°å¯¹åº”å¤§å°çš„ chunkï¼Œå°±ä¼šå°è¯•ä» Unsorted Bin ä¸­å¯»æ‰¾  chunkã€‚å¦‚æœå–å‡ºæ¥çš„ chunk å¤§å°åˆšå¥½æ»¡è¶³ï¼Œå°±ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œå¦åˆ™å°±ä¼šæŠŠè¿™äº› chunk åˆ†åˆ«æ’å…¥åˆ°å¯¹åº”çš„ bin ä¸­ã€‚</li>
</ol>
<h3 id="ä½œç”¨">ä½œç”¨</h3>
<p>ä»»æ„åœ°å€æ³„éœ² main_arena ï¼Œä»»æ„åœ°å€å†™å…¥ main_arena å›ºå®šåç§»åœ°å€(å¾ˆå¤§çš„æ•°å­—)ï¼Œä¸ºåç»­æ”»å‡»åšå‡†å¤‡ã€‚</p>
<h3 id="ç›¸å…³ä»£ç -2">ç›¸å…³ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//victim å–æœ€å…ˆè¿›å…¥ unsortedchunk çš„ chunk</span></span><br><span class="line">      <span class="comment">//unsortedchunk ä¸ä¸ºç©ºåˆ™éå†</span></span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">//è¿™é‡Œæˆ‘ä»¬æå‰å¸ƒç½®å¥½ victim-&gt;bk = target_addr - 0x10</span></span><br><span class="line">          bck = victim-&gt;bk;	</span><br><span class="line">          </span><br><span class="line"><span class="comment">//è¿™ä¸€éƒ¨åˆ†ä»£ç æ˜¯æ£€æŸ¥å’Œ remainder ç›¸å…³å†…å®¹ å¯ä»¥å…ˆè·³åˆ°åä¸€æ®µ /**********************************************************************************************************/</span></span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">				   &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): memory corruption&quot;</span>);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              remainder = chunk_at_offset (victim, nb);</span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line"><span class="comment">//è¿™é‡Œå®ç°äº†Unsortedbin Attack</span></span><br><span class="line"><span class="comment">/**********************************************************************************************************/</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// é‚£è¿™é‡Œå°±ä¼šåœ¨ target_addr çš„ä½ç½®ä¸Šå†™å…¥ å†™å…¥ main_arena å›ºå®šåç§»åœ°å€ (å¾ˆå¤§çš„æ•°å­—)</span></span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line">          </span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯æ‹¿å‡ºæ¥çš„ bin åˆ†é…çš„ç›¸å…³ä»£ç ï¼Œä¹Ÿå¯ä»¥å…ˆè·³è¿‡</span></span><br><span class="line"><span class="comment">/**********************************************************************************************************/</span></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">		set_non_main_arena (victim);</span><br><span class="line">              </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	      <span class="comment">/* Fill cache first, return to user only if cache fills.</span></span><br><span class="line"><span class="comment">		 We may return one of these chunks later.  */</span></span><br><span class="line">	      <span class="keyword">if</span> (tcache_nb	&amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line"></span><br><span class="line">          &#123;</span><br><span class="line">            tcache_put (victim, tc_idx);</span><br><span class="line">            return_cached = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">          ......</span><br></pre></td></tr></table></figure>
<h3 id="å…³é”®ä»£ç ">å…³é”®ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">//è¿™é‡Œæˆ‘ä»¬æå‰å¸ƒç½®å¥½ victim-&gt;bk = target_addr - 0x10</span></span><br><span class="line">      bck = victim-&gt;bk;	</span><br><span class="line">   ...</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line"><span class="comment">// é‚£è¿™é‡Œå°±ä¼šåœ¨ target_addr çš„ä½ç½®ä¸Šå†™å…¥ main_arena å›ºå®šåç§»åœ°å€</span></span><br><span class="line">      bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>
<h3 id="æ£€æŸ¥ä»£ç ">æ£€æŸ¥ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (size &lt;= CHUNK_HDR_SZ)</span><br><span class="line">              || __glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid size (unsorted)&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; CHUNK_HDR_SZ)</span><br><span class="line">              || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)</span><br><span class="line">              || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (prev_inuse (next)))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);</span><br><span class="line">...</span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br><span class="line"></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>
<p>â€‹	Unsortedbin Attack æœ‰ç‚¹ bug ï¼Œç»™å †åˆ©ç”¨æä¾›äº†å¾ˆå¤§ä¾¿åˆ©ï¼Œäºæ˜¯å°±è¢«è¿™ä¸€æ®µæ£€æŸ¥ä»£ç ç»™ <span class="emoji" alias="hocho" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f52a.png?v8">ğŸ”ª</span> äº†ã€‚</p>
<p>â€‹	ä¸Šé¢çš„ä¸€æ®µæ£€æŸ¥ä»£ç åœ¨ <strong>libc 2.28</strong>  å‰ä¸€èˆ¬æ˜¯æ²¡æœ‰çš„ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™-2">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unsorted-bin-attack/">Unsorted Bin Attack - CTF Wiki</a></p>
<hr>
<h2 id="Largebin-Attack">Largebin Attack</h2>
<p>â€‹	Unsortedbin Attack å¤ªå¥½ç”¨äº†æ‰€ä»¥è¢«æ£€æŸ¥ä»£ç  <span class="emoji" alias="sheep" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8">ğŸ‘</span> äº†ï¼Œå¥½åœ¨ Largebin å¯ä»¥å®ç°ç±»ä¼¼çš„æ•ˆæœã€‚</p>
<h3 id="ç›¸å…³ä»£ç -3">ç›¸å…³ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//victim å–æœ€å…ˆè¿›å…¥ unsortedchunk çš„ chunk</span></span><br><span class="line">      <span class="comment">//unsortedchunk ä¸ä¸ºç©ºåˆ™éå†</span></span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// bck ä¸º æ¬¡ æœ€å…ˆè¿›å…¥ unsortedbin çš„ chunk</span></span><br><span class="line">          bck = victim-&gt;bk;	</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">				   &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): memory corruption&quot;</span>);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// å¦‚æœæ‰€è¯·æ±‚çš„ chunk å±äº smallbin çš„èŒƒå›´</span></span><br><span class="line">          <span class="comment">// unsortedbinåªæœ‰ victim ä¸€ä¸ª chunk</span></span><br><span class="line">          <span class="comment">// victim æ˜¯ last_reminder ï¼Œåˆ†é…è¯·æ±‚çš„ chunk åçš„å¤§å°ä¾ç„¶å¤§äº MINSIZE</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// åˆ‡å‰² reminder åˆ†é… chunk å¹¶è®°å½•æ–°çš„ reminder ä¿¡æ¯</span></span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              remainder = chunk_at_offset (victim, nb);</span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">// è®¾ç½® victim å’Œ reminder chunk ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              <span class="comment">// è®¾ç½® reminder é«˜åœ°å€çš„ chunk ä¿¡æ¯</span></span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              <span class="comment">// è¿›ä¸€æ­¥æ£€æŸ¥åè¿”å› chunk</span></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line">          <span class="comment">// æŠŠå–å‡ºçš„ chunk åˆ†é…åˆ°åˆé€‚çš„ bin é‡Œ</span></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">				set_non_main_arena (victim);</span><br><span class="line">              </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	      <span class="comment">/* Fill cache first, return to user only if cache fills.</span></span><br><span class="line"><span class="comment">		 We may return one of these chunks later.  */</span></span><br><span class="line">	      <span class="keyword">if</span> (tcache_nb	&amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line"></span><br><span class="line">          &#123;</span><br><span class="line">            tcache_put (victim, tc_idx);</span><br><span class="line">            return_cached = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* place chunk in bin */</span></span><br><span class="line">              <span class="comment">//å¦‚æœåœ¨ smallbin çš„èŒƒå›´å†…</span></span><br><span class="line">              <span class="comment">//åªç”¨å¸ƒç½®å¥½ bck å’Œ fwd ç„¶åè·³åˆ°æœ€å victim å…¥é“¾ </span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = smallbin_index (size);		<span class="comment">// è®¡ç®—å¾—åˆ° victim å°†è¢«æ”¾å…¥çš„ bin çš„ index</span></span><br><span class="line">              bck = bin_at (av, victim_index);			<span class="comment">// bck ä¸ºè¢«æ”¾å…¥çš„ bin çš„é“¾è¡¨å¤´</span></span><br><span class="line">              fwd = bck-&gt;fd;						<span class="comment">// fwd ä¸ºæœ€è¿‘åŠ å…¥ smallbin çš„ chunk å¤´</span></span><br><span class="line">            &#125;</span><br><span class="line">              <span class="comment">//å¦‚æœå±äº largebin çš„è¯è¿˜è¦å¸ƒç½®å¥½ size ç›¸å…³æŒ‡é’ˆ</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = largebin_index (size);		<span class="comment">// è®¡ç®—å¾—åˆ° victim å°†è¢«æ”¾å…¥çš„ bin çš„ index</span></span><br><span class="line">              bck = bin_at (av, victim_index);			<span class="comment">// bck ä¸ºè¢«æ”¾å…¥çš„ bin çš„é“¾è¡¨å¤´</span></span><br><span class="line">              fwd = bck-&gt;fd;						<span class="comment">// fwd ä¸ºè¯¥é“¾è¡¨ä¸­æœ€å¤§çš„ chunk</span></span><br><span class="line">				</span><br><span class="line">              <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">              <span class="comment">//è¯¥é“¾è¡¨ä¸ä¸ºç©º</span></span><br><span class="line">              <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                  size |= PREV_INUSE;</span><br><span class="line">                  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                  assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">                  </span><br><span class="line">                  <span class="comment">//bck-&gt;bk æ˜¯è¯¥é“¾è¡¨ä¸­æœ€å°çš„ chunk ï¼Œå¦‚æœ victim æ¯”å®ƒè¿˜å°</span></span><br><span class="line">                  <span class="comment">//åˆ™å°†å®ƒæ›´æ”¹ä¸ºæœ€å°çš„ chunk</span></span><br><span class="line">                  </span><br><span class="line">                  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">                    &#123;</span><br><span class="line">                      fwd = bck;				<span class="comment">//æ­¤æ—¶ fwd ä¸ºé“¾è¡¨å¤´</span></span><br><span class="line">                      bck = bck-&gt;bk;			<span class="comment">//æ­¤æ—¶ bck ä¸ºæœ€å°çš„ chunk</span></span><br><span class="line">						</span><br><span class="line">                      <span class="comment">//æ—¢ç„¶ victim è¦æˆä¸ºæœ€å°çš„ chunk ï¼Œé‚£ä¹ˆå®ƒçš„ fd_nextsize æŒ‡é’ˆåº”è¯¥æŒ‡å‘æœ€å¤§çš„ chunk</span></span><br><span class="line">                      <span class="comment">//ä¹Ÿå°±æ˜¯æ­¤æ—¶çš„ fwd-&gt;fd</span></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                      </span><br><span class="line">                      <span class="comment">//é‚£ä¹ˆ bk_nextsize å°±æŒ‡å‘åŸæ¥æœ€å°çš„ chunk</span></span><br><span class="line">                      <span class="comment">//é“¾è¡¨ä¸­æœ€å¤§çš„ chunk çš„ bk_nextsize æŒ‡å‘é“¾è¡¨ä¸­æœ€å°çš„é‚£ä¸ª chunk</span></span><br><span class="line">                      <span class="comment">//é‚£ä¹ˆå°±æ˜¯ fwd-&gt;fd-&gt;bk_nextsize</span></span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                      </span><br><span class="line">                      <span class="comment">//è¿™é‡ŒæŠŠæœ€å¤§ chunk çš„ bk_nextsize æ”¹æˆæˆ‘ä»¬çš„ victim</span></span><br><span class="line">                      <span class="comment">//æŠŠåŸæœ¬æœ€å° chunk çš„ fd_nextsize æ”¹æˆæˆ‘ä»¬çš„ victim</span></span><br><span class="line">                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      assert (chunk_main_arena (fwd));</span><br><span class="line">                      </span><br><span class="line">                      <span class="comment">//åœ¨ largebin çš„åŒä¸€ä¸ªåºåˆ—ä¸­çš„ chunk é¡ºç€ fd_nextsize çš„æ–¹å‘ size å˜å°</span></span><br><span class="line">                      <span class="comment">//è¿™ä¸ªå¾ªç¯çš„æ„æ€æ˜¯æ‰¾åˆ°ä¸€ä¸ªæ¯”å½“å‰ fwd æŒ‡çš„ chunk è¦å¤§çš„åœ°å€ï¼Œå­˜å…¥ fwd ä¸­ã€‚</span></span><br><span class="line">                      <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; chunksize_nomask (fwd))</span><br><span class="line">                        &#123;</span><br><span class="line">                          fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">			              assert (chunk_main_arena (fwd));</span><br><span class="line">                        &#125;</span><br><span class="line">                      </span><br><span class="line">                      <span class="comment">//å¦‚æœæ‰¾åˆ°äº†ä¸ªå’Œ victim å¤§å°ç›¸åŒçš„ chunkï¼Œé‚£å°±ç›´æ¥å®‰æ’</span></span><br><span class="line">                      <span class="comment">//å®‰æ’å¥½ fwd å’Œ bck åå¿«è¿›åˆ° victim å…¥é“¾</span></span><br><span class="line">                      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                          fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                        &#125;</span><br><span class="line">                      bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                </span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          mark_bin (av, victim_index);</span><br><span class="line">          victim-&gt;bk = bck;</span><br><span class="line">          victim-&gt;fd = fwd;</span><br><span class="line">          fwd-&gt;bk = victim;</span><br><span class="line">		  bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>
<h3 id="å…³é”®ä»£ç -2">å…³é”®ä»£ç </h3>
<h4 id="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€</h4>
<p>â€‹	Unsortedbin ä¸­å­˜æ”¾ä¸€ä¸ª size è¾ƒå¤§çš„ chunk (CHUNK)ï¼ŒLargebin é‡Œé¢æ”¾ä¸€ä¸ª size è¾ƒå°çš„ chunk (victim)ï¼Œè¿™æ ·å°±å¯ä»¥è¿›å…¥ä¸‹é¢çš„å¾ªç¯ã€‚</p>
<p>â€‹	å…¶ä¸­ï¼Œæˆ‘ä»¬æå‰å¸ƒç½®å¥½ CHUNK é‡Œé¢çš„ bk_nextsize ä¸º target_addr <strong>-0x20</strong> ï¼Œåˆ™ target_addr ä½ç½®å°†è¢«ä¿®æ”¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">  &#123;</span><br><span class="line">    fwd = bck;				<span class="comment">//æ­¤æ—¶ fwd ä¸ºé“¾è¡¨å¤´</span></span><br><span class="line">    bck = bck-&gt;bk;			<span class="comment">//æ­¤æ—¶ bck ä¸º CHUNK</span></span><br><span class="line">						</span><br><span class="line">    <span class="comment">//æ­¤æ—¶çš„ fwd-&gt;fd æŒ‡å‘ CHUNK</span></span><br><span class="line">    </span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//CHUNK çš„ bk_nextsize = target_addr - 0x20</span></span><br><span class="line">    </span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//victim-&gt;bk_nextsize-&gt;fd_nextsize = victim ä¼šå°†</span></span><br><span class="line">    <span class="comment">//CHUNK çš„ bk_nextsize + 0x20 å¤„çš„å€¼ä¿®æ”¹ä¹˜ victim</span></span><br><span class="line">    </span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ–¹æ³•äºŒï¼ˆ-libc-2-30ï¼‰">æ–¹æ³•äºŒï¼ˆ&lt; libc 2.30ï¼‰</h4>
<p>â€‹	Unsortedbin é‡Œé¢æ”¾ä¸€ä¸ª size è¾ƒå°çš„ chunk (ä¸‹é¢çš„ fwd-&gt;fd), Largebin ä¸­å­˜æ”¾ä¸€ä¸ª size è¾ƒå¤§çš„ chunk (ä¸‹é¢çš„ victim )ï¼Œè¿™æ ·å°±å¯ä»¥è¿›å…¥ä¸‹é¢çš„å¾ªç¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">     </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                 </span><br><span class="line">                 victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                 </span><br><span class="line">           <span class="comment">/* è¿™é‡Œæˆ‘ä»¬æå‰å¸ƒç½®å¥½äº† fwd-&gt;bk_nextsize = target_addr_1 -0x20 */</span></span><br><span class="line">                 </span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                 fwd-&gt;bk_nextsize = victim;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/* æ‰€ä»¥ target_addr_1 å¤„çš„å€¼ä¼šè¢«ä¿®æ”¹æˆ victim (ä¸€ä¸ªå¾ˆå¤§çš„æ•°) */</span></span><br><span class="line">                 </span><br><span class="line">                 victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">             </span><br><span class="line">           <span class="comment">/* è¿™é‡Œæˆ‘ä»¬æå‰å¸ƒç½®å¥½äº† fwd-&gt;bk = target_addr_2 -0x10 */</span></span><br><span class="line">             </span><br><span class="line">             bck = fwd-&gt;bk;</span><br><span class="line">           &#125;</span><br><span class="line">       </span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">       victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> mark_bin (av, victim_index);</span><br><span class="line"> victim-&gt;bk = bck;</span><br><span class="line"> victim-&gt;fd = fwd;</span><br><span class="line"> fwd-&gt;bk = victim;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ‰€ä»¥ target_addr_2 å¤„çš„å€¼ä¼šè¢«ä¿®æ”¹æˆ victim (ä¸€ä¸ªå¾ˆå¤§çš„æ•°)</span></span><br><span class="line"></span><br><span class="line"> bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>
<h3 id="æ£€æŸ¥ä»£ç -2">æ£€æŸ¥ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">   <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">      fwd = fwd-&gt;fd;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            victim-&gt;fd_nextsize = fwd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">                 malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">                 fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                 victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">             bck = fwd-&gt;bk;</span><br><span class="line">             <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">               malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">       victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> mark_bin (av, victim_index);</span><br><span class="line"> victim-&gt;bk = bck;</span><br><span class="line"> victim-&gt;fd = fwd;</span><br><span class="line"> fwd-&gt;bk = victim;</span><br><span class="line"> bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥ä»£ç ä½¿æ–¹æ³•äºŒéš¾ä»¥åˆ©ç”¨ï¼Œä½†æ–¹æ³•ä¸€ä»æ˜¯å¯è¡Œçš„ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™-3">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://eur1ka.github.io/9434.html">unsortedbin-largebinæ”»å‡» - eur1kaâ€™s blog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/183877">ptmallocåˆ©ç”¨ä¹‹largebin attack - raycp</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5177">æµ…ælargebin attack - Sr0cky</a></p>
<hr>
<h2 id="Unsafe-Unlink">Unsafe Unlink</h2>
<p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/posts/unlink_smallbin_intro.png" alt=""></p>
<h3 id="æ¡ä»¶">æ¡ä»¶</h3>
<ol>
<li>UAF ï¼Œå¯ä¿®æ”¹ free çŠ¶æ€ä¸‹ smallbin æˆ–æ˜¯ unsortedbin çš„ fd å’Œ bk æŒ‡é’ˆ</li>
<li>å·²çŸ¥ä½ç½®å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯è¿›è¡Œ UAF çš„ chunk</li>
</ol>
<h3 id="æ•ˆæœ-2">æ•ˆæœ</h3>
<p>ä½¿å¾—å·²æŒ‡å‘ UAF chunk çš„æŒ‡é’ˆ ptr å˜ä¸º ptr - 0x18</p>
<h3 id="ç›¸å…³æºç -libc-2-35">ç›¸å…³æºç (libc 2.35)</h3>
<p>å€¼å¾—è¯´æ˜çš„æ˜¯ï¼Œé«˜ç‰ˆæœ¬çš„ unlink è¢«å®ç°æˆäº†å‡½æ•°ï¼Œè€Œä½ç‰ˆæœ¬çš„åˆ™æ˜¯å®(#define unlink(AV, P, BK, FD))ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 1.è¢« unlink çš„ chunk å¤§å°è¦å’Œä¸‹ä¸€ä¸ª chunk çš„ prev_size ç›¸åŒ</span></span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line">  <span class="comment">// 2.å¯¹ fd å’Œ bk çš„æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="comment">// 3.ä¸å±äº smallbin çš„è¯ï¼Œè¿˜è¦è¿›è¡Œé¢å¤–çš„å·¥ä½œ</span></span><br><span class="line">  <span class="comment">// smallbin ä¸­çš„ chunk çš„ fdnextsize å’Œ bknextsize æ˜¯æ²¡æœ‰æ„ä¹‰çš„</span></span><br><span class="line">  <span class="comment">// å³ä½¿æ˜¯ largebinï¼Œä¹Ÿåªæœ‰åœ¨ç›¸åŒå°ºå¯¸çš„åŒä¸€ç»„ chunks ä¸­çš„ç¬¬ä¸€ä¸ª chunk ä¸­ fdnextsize ä»¥åŠ bknextsize æ‰æœ‰æ„ä¹‰</span></span><br><span class="line">  <span class="comment">// p-&gt;fd_nextsize != NULL è¯´æ˜ P æ˜¯ å°ºå¯¸ç›¸åŒçš„ä¸€ç»„ chunksçš„ç¬¬ä¸€ä¸ª chunk</span></span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">          || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">            fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">              fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">              p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">              p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">            &#125;</span><br><span class="line">     &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">          p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å…³é”®ä»£ç -3">å…³é”®ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr fd = p-&gt;fd;</span><br><span class="line">mchunkptr bk = p-&gt;bk;</span><br><span class="line">fd-&gt;bk = bk;</span><br><span class="line">bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure>
<p>â€‹	æˆ‘ä»¬å…ˆä¸ç®¡ä¸Šé¢æ ‡æ³¨ 1 2 3 çš„æ£€æŸ¥ä»£ç æ®µã€‚</p>
<p>â€‹	è¿™ä¿©å°æ®µä»£ç å¯ä»¥ä¿®æ”¹ p-&gt;fd æŒ‡å‘åœ°å€çš„ <strong>+ 0x18</strong> (p-&gt;fdæŒ‡å‘åœ°å€çš„bk) çš„å†…å®¹ä¸º p-&gt;bk ï¼Œp-&gt;bk æŒ‡å‘åœ°å€çš„ <strong>+ 0x10</strong> (p-&gt;bkæŒ‡å‘åœ°å€çš„ fd) å†…å®¹ä¸º p-&gt;fd ã€‚</p>
<p>â€‹	å…¶å®å¾ˆå¥½ç†è§£ï¼Œå¦‚æœæ˜¯æ­£å¸¸çš„é“¾è¡¨è¿›è¡Œ unlink ï¼Œå°±æ˜¯å°† p æ‹¿å‡ºæ¥ï¼Œp å‰é¢å—çš„ bk æŒ‡å‘ p çš„ bkï¼Œp åé¢å—çš„ fd æŒ‡å‘ p çš„ fdã€‚è¿™æ ·åœ¨æ‹¿å‡ºäº† p åï¼Œé“¾è¡¨æ‰èƒ½ä¿æŒå®Œæ•´ã€‚</p>
<p>â€‹	ä½†å¦‚æœæˆ‘ä»¬é€šè¿‡æŸç§æ–¹å¼è¾¾åˆ°äº†ä»»æ„æ§åˆ¶ p çš„ fd ä¸ bk æŒ‡é’ˆçš„æ•ˆæœï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨ p-&gt;fd æŒ‡å‘åœ°å€çš„ <strong>+ 0x18</strong> å¤„å†™ä¸Š bk ï¼Œä¹Ÿå°±è¾¾åˆ°äº†ä»»æ„å†™çš„æ•ˆæœï¼Œé‚£å²‚ä¸æ˜¯ç®€ç®€å•å•å°±æŠŠä¸€ä¸ªç¨‹åºç»™ <span class="emoji" alias="sheep" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8">ğŸ‘</span> äº†ã€‚</p>
<p><em>PSï¼šæŒ‡å‘åœ°å€ï¼Ÿ</em></p>
<p>â€‹	ä¸‹å›¾æ˜¯ä¸€ä¸ªè¢« free æ‰è¿›å…¥ unsorted bin åçš„å›¾ç¤ºï¼Œé‚£ä¹ˆæœ¬æ–‡ä¸­æˆ‘ä»¬çº¦å®šæ­¤å¤„ p-&gt;fd çš„æŒ‡å‘åœ°å€æ˜¯åœ¨è¯´ 0x00000000006a0090 è€Œä¸æ˜¯ 0x6a01c0 ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| <span class="number">0x6a01b0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000091</span>   |&lt;----|p_addr|prev_size|size|</span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| <span class="number">0x6a01c0</span>:  | <span class="number">0x00000000006a0090</span>  | <span class="number">0x00007f63cea65b78</span>   |&lt;----|p_addr+<span class="number">0x10</span>|p-&gt;fd|p-&gt;bk|</span><br><span class="line">| <span class="number">0x6a01d0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br></pre></td></tr></table></figure>
<h3 id="ç»•è¿‡æ£€æŸ¥">ç»•è¿‡æ£€æŸ¥</h3>
<p>ä¸ºäº†ç»•è¿‡ä¸Šè¿°çš„æ£€æŸ¥ï¼ŒUnlink æ”»å‡»å¤±å»äº†ä¸€å¼€å§‹ä»»æ„å†™çš„èƒ½åŠ›ï¼Œä½†ä»æœ‰ä¸€å®šä½œç”¨ã€‚</p>
<ol>
<li>
<p>è¿™ä¸ªå¾ˆå¥½è§£å†³ï¼Œåªè¦æˆ‘ä»¬æ„é€  chunk çš„æ—¶å€™æ³¨æ„ç‚¹å°±å¥½ã€‚</p>
</li>
<li>
<p>è¿™ä¸ªéå¸¸è‡´å‘½ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ <strong>fd-&gt;bk == p &amp;&amp; bk-&gt;fd == p</strong></p>
</li>
</ol>
<p>é‚£ä¹ˆä¸ºäº†é¡ºåˆ©çš„æäº‹æƒ…ï¼Œæˆ‘ä»¬å°±è¦ä½¿ p-&gt;fd æŒ‡å‘åœ°å€çš„ <strong>+ 0x18</strong> çš„å†…å®¹ä¸ºæŒ‡å‘ p çš„åœ°å€ ï¼Œp-&gt;bk æŒ‡å‘åœ°å€çš„ <strong>+ 0x10</strong> (p-&gt;bkæŒ‡å‘åœ°å€çš„ fd) å†…å®¹ä¸ºæŒ‡å‘ p çš„åœ°å€ã€‚</p>
<p>é‚£ä¹ˆå‡è®¾æˆ‘ä»¬è¿™é‡Œæœ‰ä¸€ä¸ªæŒ‡å‘ p è¿™ä¸ª chunk çš„ chunk å¤´åœ°å€çš„æŒ‡é’ˆ <strong>Ptr</strong> (è¿™é‡Œå‡è®¾ chunk å¤´åœ°å€ä¸º 0x6a01b0, chunk æŒ‡é’ˆåœ°å€ä¸º<strong>0x602100</strong>)</p>
<p>æˆ‘ä»¬å°±è¦åœ¨ p-&gt;fd å¤„å†™ä¸Š <strong>Ptr - 0x18</strong> ï¼Œp-&gt;bk å¤„å†™ä¸Š <strong>Ptr - 0x10</strong> ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| <span class="number">0x6020e0</span>:  | <span class="number">0x00000000006a0010</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">| <span class="number">0x6020f0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">| <span class="number">0x602100</span>:  | <span class="number">0x00000000006a01b0</span>  | <span class="number">0x0000000000000088</span>   |&lt;---- Ptr <span class="number">0x602100</span></span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¦‚ä¸‹æ„é€  chunk pï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| <span class="number">0x6a01b0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000091</span>   | &lt;----|p_addr|prev_size|size|</span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| <span class="number">0x6a01c0</span>:  | <span class="number">0x00000000006a20e8</span>  | <span class="number">0x00000000006020f0</span>   | &lt;----|p_addr+<span class="number">0x10</span>|p-&gt;fd|p-&gt;bk|</span><br><span class="line">| <span class="number">0x6a01d0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">| <span class="number">0x6a01e0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ p-&gt;fd = 0x6020e8 = 0x602100 - 0x18 ï¼Œé‚£ä¹ˆ p-&gt;fd <strong>+0x18</strong> çš„åœ°æ–¹æ°å¥½æ˜¯å­˜æ”¾ p è¿™ä¸ª chunk çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±å®Œæˆäº†ç»•è¿‡ï¼Œbk åŒç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr fd = p-&gt;fd; <span class="comment">//fd = 0x6a20e8 Ptr-0x18</span></span><br><span class="line">mchunkptr bk = p-&gt;bk; <span class="comment">//bk = 0x6020f0 Ptr-0x10</span></span><br><span class="line">fd-&gt;bk = bk;	<span class="comment">// Ptr = Ptr - 0x10</span></span><br><span class="line">bk-&gt;fd = fd;	<span class="comment">// Ptr = Ptr - 0x18</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.</span> Before:</span><br><span class="line">   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">   | <span class="number">0x6020e0</span>:  | <span class="number">0x00000000006a0010</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">   | <span class="number">0x6020f0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">   | <span class="number">0x602100</span>:  | <span class="number">0x00000000006a01b0</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line"><span class="number">1.</span> fd-&gt;bk = bk;			</span><br><span class="line">   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">   | <span class="number">0x6020e0</span>:  | <span class="number">0x00000000006a0010</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">   | <span class="number">0x6020f0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">   | <span class="number">0x602100</span>:  | <span class="number">0x00000000006020f0</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line"><span class="number">2.</span> bk-&gt;fd = fd;</span><br><span class="line">   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">   | <span class="number">0x6020e0</span>:  | <span class="number">0x00000000006a0010</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">   | <span class="number">0x6020f0</span>:  | <span class="number">0x0000000000000000</span>  | <span class="number">0x0000000000000000</span>   |</span><br><span class="line">   | <span class="number">0x602100</span>:  | <span class="number">0x00000000006a20e8</span>  | <span class="number">0x0000000000000088</span>   |</span><br><span class="line">   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±è¾¾åˆ°äº† <strong>â€œä½¿å¾—å·²æŒ‡å‘ UAF chunk çš„æŒ‡é’ˆ Ptr å˜ä¸º Ptr - 0x18â€</strong> è¿™ä¸€æœ€ç»ˆæ•ˆæœã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™-4">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unlink/">Unlink - CTF Wiki</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1557872">ä¸€é“é¢˜å½»åº•ç†è§£ Pwn Heap Unlink</a></p>
<hr>
<h2 id="Tcache-Stashing-Unlink-Attack">Tcache Stashing Unlink Attack</h2>
<h3 id="æ¡ä»¶-2">æ¡ä»¶</h3>
<ol>
<li>å­˜åœ¨ä¿© smallbin chunk ä¸”å¯¹åº”å¤§å° tcache æ”¾äº† 5 ä¸ª chunkã€‚æ„æ€æ˜¯å¡å…¥ä¿© chunk åå¯¹åº”å¤§å° Tcache å°±æ»¡äº†ã€‚(ç”¨æœ€åç»™å‡ºçš„æ„é€ æ–¹æ³•æˆ–æ²³é‡Œåˆ©ç”¨ callocç­‰)</li>
<li>UAF ï¼Œå¯ä¿®æ”¹ free çŠ¶æ€ä¸‹ smallbin çš„ bk æŒ‡é’ˆ</li>
<li>å·²çŸ¥ä½ç½®å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯è¿›è¡Œ UAF çš„ chunk</li>
</ol>
<h3 id="æ•ˆæœ-3">æ•ˆæœ</h3>
<ol>
<li>å¾€æŒ‡å‘ UAF chunk çš„æŒ‡é’ˆ ptr å†™ main_arena æ¥æ³„éœ² libc</li>
<li>åˆ†é… chunk åˆ° ptr</li>
</ol>
<h3 id="ç›¸å…³ä»£ç -4">ç›¸å…³ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Reminders about list directionality within bins */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> first(b)     ((b)-&gt;fd)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> last(b)      ((b)-&gt;bk)</span></span><br><span class="line">... </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     If a small request, check regular bin.  Since these &quot;smallbins&quot;</span></span><br><span class="line"><span class="comment">     hold one size each, no searching within bins is necessary.</span></span><br><span class="line"><span class="comment">     (For a large request, we need to wait until unsorted chunks are</span></span><br><span class="line"><span class="comment">     processed to find best fit. But for small ones, fits are exact</span></span><br><span class="line"><span class="comment">     anyway, so we can check now, which is faster.)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="comment">/*************************************************************************************/</span></span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| bin_at (av, idx)  | chunk n  | chunk n<span class="number">-1</span>  | â€¦â€¦  | chunk <span class="number">2</span>  | chunk <span class="number">1</span>  |</span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">| bin               |          |            |     | bck      | victim   |</span><br><span class="line">+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+</span><br><span class="line">    		fd</span><br><span class="line">	-------------------&gt;</span><br><span class="line"><span class="comment">/*************************************************************************************/</span> </span><br><span class="line">    <span class="comment">// å¦‚æœå±äº smallbin çš„èŒƒå›´</span></span><br><span class="line">  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// è·å– size å¤§å°å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      <span class="comment">// è·å–ä¸‹æ ‡å¯¹åº”çš„ smallbin é“¾è¡¨å¤´</span></span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line">      <span class="comment">// victim å–é“¾è¡¨çš„æœ€åä¸€ä¸ª chunk ï¼Œvictim ä¸æ˜¯é“¾è¡¨å¤´ï¼Œè¯´æ˜ä¸ä¸ºç©º</span></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// bck ä¸º å€’æ•°ç¬¬äºŒä¸ª chunk</span></span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="comment">// å®Œæ•´æ€§æ£€æŸ¥</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">/* å°†è¿”å› victim ä½œä¸ºæœ¬æ¬¡ malloc è¿”å›çš„ chunk */</span></span><br><span class="line">          <span class="comment">// ç»™ç›¸é‚»çš„é«˜åœ°å€ chunk è®¾ç½® prev_inuse ä½è¯´æ˜ victim å¤„äº use çŠ¶æ€</span></span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">/* æŠŠ victim ä»é“¾è¡¨å–å‡º */</span></span><br><span class="line">          <span class="comment">// è®°å½•çš„æœ€åä¸€ä¸ª chunk çš„ bin-&gt;bk æŒ‡å‘å€’æ•°ç¬¬äºŒä¸ª</span></span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          <span class="comment">// å€’æ•°ç¬¬äºŒä¸ª chunk å˜ä¸ºå€’æ•°ç¬¬ä¸€ä¸ªå fd æŒ‡å‘ é“¾è¡¨å¤´ bin</span></span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="comment">/*************************************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	  <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">	     stash them in the tcache.  */</span></span><br><span class="line">          <span class="comment">// ç”± malloc è¯·æ±‚çš„ size è®¡ç®— tcache ä¸‹æ ‡</span></span><br><span class="line">	  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">          <span class="comment">// tcache å­˜åœ¨ä¸”ä¸‹æ ‡å­˜åœ¨</span></span><br><span class="line">	  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">	    &#123;</span><br><span class="line">	      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">	      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">          <span class="comment">/* å½“ smallbin ä¸ä¸ºç©ºä¸” tcache å¡å¾—ä¸‹ï¼ŒæŠŠåŸæœ¬ smallbin é“¾è¡¨ä¸­çš„ chunk å¾€ tcache é‡Œé¢å¡ */</span></span><br><span class="line">	      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">		     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">		&#123;</span><br><span class="line">		  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">		    &#123;</span><br><span class="line">              <span class="comment">// bck ä¸º å€’æ•°ç¬¬äºŒä¸ª chunk</span></span><br><span class="line">              <span class="comment">/* å¾ˆæ˜æ˜¾è¿™é‡Œæ²¡æœ‰äº†å®Œæ•´æ€§æ£€æŸ¥ */</span></span><br><span class="line">		      bck = tc_victim-&gt;bk;</span><br><span class="line">              <span class="comment">// ç»™ç›¸é‚»çš„é«˜åœ°å€ chunk è®¾ç½® prev_inuse ä½</span></span><br><span class="line">		      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">              </span><br><span class="line">		      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">			set_non_main_arena (tc_victim);</span><br><span class="line">              <span class="comment">/* æŠŠ victim ä»é“¾è¡¨å–å‡º */</span></span><br><span class="line">              <span class="comment">// è®°å½•çš„æœ€åä¸€ä¸ª chunk çš„ bin-&gt;bk æŒ‡å‘å€’æ•°ç¬¬äºŒä¸ª</span></span><br><span class="line">		      bin-&gt;bk = bck;</span><br><span class="line">              <span class="comment">// å€’æ•°ç¬¬äºŒä¸ª chunk å˜ä¸ºå€’æ•°ç¬¬ä¸€ä¸ªå fd æŒ‡å‘ é“¾è¡¨å¤´ bin</span></span><br><span class="line">		      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">              <span class="comment">//æŠŠåŸæœ¬ smallbin é“¾è¡¨ä¸­çš„ chunk å¾€ tcache é‡Œé¢å¡</span></span><br><span class="line">		      tcache_put (tc_victim, tc_idx);</span><br><span class="line">	            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">          <span class="comment">// p è½¬æ¢ä¸ºä¸å« chunk å¤´çš„æŒ‡é’ˆ</span></span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="å…³é”®ä»£ç -4">å…³é”®ä»£ç </h3>
<ol>
<li>å¾€æŒ‡å‘ UAF chunk çš„æŒ‡é’ˆ ptr å†™ main_arena æ¥æ³„éœ² libc</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">  &#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡ UAF å†™ bk æŒ‡å‘ ptr - 0x10 ç»•è¿‡æ£€æŸ¥</span></span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line"> <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">   malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">        set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">        <span class="comment">// bin çš„ bk è¢«æ”¹å†™ä¸º ptr - 0x10</span></span><br><span class="line">        bin-&gt;bk = bck;</span><br><span class="line">        <span class="comment">// ptr è¢«å†™æˆ main_arena</span></span><br><span class="line">        bck-&gt;fd = bin;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>åˆ†é… chunk åˆ° ptr ä¸Šæ–¹</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">     <span class="comment">// å€¼å¾—æ³¨æ„çš„æ˜¯ last(bin) æ˜¯æŒ‡ bin-&gt;bk</span></span><br><span class="line">     <span class="comment">// ä½†æ˜¯ bin-&gt;bk å·²ç»è¢«æˆ‘ä»¬ä¸çŸ¥é“æ‰¬åˆ°å“ªé‡Œå»äº†ï¼Œæ‰€ä»¥è¦ä¿è¯ Tcache é‡Œé¢</span></span><br><span class="line">     <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">&#123;</span><br><span class="line">     <span class="comment">// victim å–çš„æ˜¯æˆ‘ä»¬ä¸Šé¢æ”¹å†™çš„ ptr - 0x10</span></span><br><span class="line">  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      bck = tc_victim-&gt;bk;</span><br><span class="line">      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	set_non_main_arena (tc_victim);</span><br><span class="line">      bin-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = bin;</span><br><span class="line">            </span><br><span class="line">     <span class="comment">// æŠŠ ptr - 0x10 å¤„ chunk æ”¾å…¥äº† tcache</span></span><br><span class="line">      tcache_put (tc_victim, tc_idx);</span><br><span class="line">            </span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ³¨æ„-3">æ³¨æ„</h3>
<p>Smallbin ä¸­ç›¸é‚»çš„ä¿© free chunk ä¼šåˆå¹¶ï¼Œæ„é€ æ—¶éœ€è¦é¿å…è¿™ç§æƒ…å†µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//now we malloc 9 chunks</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">    chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//put 7 tcache</span></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"><span class="comment">//last tcache bin</span></span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">//now they are put into unsorted bin</span></span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//convert into small bin</span></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">//&gt;0x90</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//now 5 tcache bins</span></span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™-5">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/tcache-attack/#tcache-stashing-unlink-attack">Tcache attack - CTF Wiki</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">uuu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://caffelne.github.io/posts/53983.html">http://caffelne.github.io/posts/53983.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://caffelne.github.io" target="_blank">uuu</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A0%86/">å †</a></div><div class="post_share"><div class="social-share" data-image="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/pwn_1@Lifeline.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/21b97b6b.html"><img class="prev-cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/pwn_2@Lifeline.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Pwn åˆ·é¢˜ç¬”è®°</div></div></a></div><div class="next-post pull-right"><a href="/posts/1976.html"><img class="next-cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/BASE1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ä¿©é“ Base é¢˜ç›®</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/c65a48dc.html" title="ã€Game.04ã€‘2021 ç¾ŠåŸæ¯ Pwn å¤ç°"><img class="cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/2021_ycb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-07</div><div class="title">ã€Game.04ã€‘2021 ç¾ŠåŸæ¯ Pwn å¤ç°</div></div></a></div><div><a href="/posts/fe829aea.html" title="ã€Game.01ã€‘Wolvsec2022 Pwn WriteUp"><img class="cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Wolvsec.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="title">ã€Game.01ã€‘Wolvsec2022 Pwn WriteUp</div></div></a></div><div><a href="/posts/5ae36485.html" title="ã€Heap.03ã€‘House of ç³»åˆ—å­¦ä¹ "><img class="cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/1140961.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-23</div><div class="title">ã€Heap.03ã€‘House of ç³»åˆ—å­¦ä¹ </div></div></a></div><div><a href="/posts/d6d32804.html" title="ã€Heap.05ã€‘Glibc 2.32 ä»¥ä¸Šçš„æŒ‡é’ˆå¼‚æˆ–åŠ å¯†æœºåˆ¶è¯¦è§£ä»¥åŠä¿©é“ä¾‹é¢˜"><img class="cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/wallhaven-76dg8y.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-03</div><div class="title">ã€Heap.05ã€‘Glibc 2.32 ä»¥ä¸Šçš„æŒ‡é’ˆå¼‚æˆ–åŠ å¯†æœºåˆ¶è¯¦è§£ä»¥åŠä¿©é“ä¾‹é¢˜</div></div></a></div><div><a href="/posts/21b97b6b.html" title="Pwn åˆ·é¢˜ç¬”è®°"><img class="cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Cover/pwn_2@Lifeline.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-12</div><div class="title">Pwn åˆ·é¢˜ç¬”è®°</div></div></a></div><div><a href="/posts/87eea22c.html" title="ã€Heap.02ã€‘åœ¨å‡ºé¢˜äººä¿æŠ¤å…¨å¼€çš„å›´å µä¸‹æŠ“ä½ä¸€çº¿ç”Ÿæœº"><img class="cover" src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/1140962.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-21</div><div class="title">ã€Heap.02ã€‘åœ¨å‡ºé¢˜äººä¿æŠ¤å…¨å¼€çš„å›´å µä¸‹æŠ“ä½ä¸€çº¿ç”Ÿæœº</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">uuu</div><div class="author-info__description">è·¯è¿˜é•¿ æ¢¦è¿˜å¤š</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">19</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/caffelne"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/caffelne" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Off-by-one"><span class="toc-number">1.1.</span> <span class="toc-text">Off by one</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">åˆ©ç”¨æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.1.2.</span> <span class="toc-text">å¸¸è§æ¼æ´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%A2%98%E7%9B%AE%E8%AE%B0%E5%BD%95"><span class="toc-number">1.1.3.</span> <span class="toc-text">ç›¸å…³é¢˜ç›®è®°å½•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chunk-Extend-and-Overlapping"><span class="toc-number">1.2.</span> <span class="toc-text">Chunk Extend and Overlapping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F-2"><span class="toc-number">1.2.1.</span> <span class="toc-text">æ³¨æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-number">1.2.2.</span> <span class="toc-text">æ•ˆæœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">1.2.3.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%A4%BA%E4%BE%8B-libc-2-23%E4%B8%8B-%EF%BC%8Clibc-2-27-%E5%88%99%E5%85%88%E5%A4%84%E7%90%86-Tcache"><span class="toc-number">1.2.4.</span> <span class="toc-text">åˆ©ç”¨ç¤ºä¾‹(libc 2.23ä¸‹ ï¼Œlibc 2.27 åˆ™å…ˆå¤„ç† Tcache)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.5.</span> <span class="toc-text">ç›¸å…³ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink-%E7%BB%95%E8%BF%87%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.6.</span> <span class="toc-text">unlink ç»•è¿‡åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#libc-2-29-%E6%A3%80%E6%B5%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.7.</span> <span class="toc-text">libc 2.29 æ£€æµ‹ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.2.8.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsortedbin-Attack-libc-2-28"><span class="toc-number">1.3.</span> <span class="toc-text">Unsortedbin Attack(&lt; libc 2.28)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9D%A5%E6%BA%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">åŸºæœ¬æ¥æº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">1.3.2.</span> <span class="toc-text">åŸºæœ¬ä½¿ç”¨æƒ…å†µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">ä½œç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.3.4.</span> <span class="toc-text">ç›¸å…³ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.5.</span> <span class="toc-text">å…³é”®ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.6.</span> <span class="toc-text">æ£€æŸ¥ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-2"><span class="toc-number">1.3.7.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Largebin-Attack"><span class="toc-number">1.4.</span> <span class="toc-text">Largebin Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">ç›¸å…³ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">å…³é”®ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">æ–¹æ³•ä¸€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%88-libc-2-30%EF%BC%89"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">æ–¹æ³•äºŒï¼ˆ&lt; libc 2.30ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.4.3.</span> <span class="toc-text">æ£€æŸ¥ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe-Unlink"><span class="toc-number">1.5.</span> <span class="toc-text">Unsafe Unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.5.1.</span> <span class="toc-text">æ¡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%88%E6%9E%9C-2"><span class="toc-number">1.5.2.</span> <span class="toc-text">æ•ˆæœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81-libc-2-35"><span class="toc-number">1.5.3.</span> <span class="toc-text">ç›¸å…³æºç (libc 2.35)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81-3"><span class="toc-number">1.5.4.</span> <span class="toc-text">å…³é”®ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%A3%80%E6%9F%A5"><span class="toc-number">1.5.5.</span> <span class="toc-text">ç»•è¿‡æ£€æŸ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-4"><span class="toc-number">1.5.6.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tcache-Stashing-Unlink-Attack"><span class="toc-number">1.6.</span> <span class="toc-text">Tcache Stashing Unlink Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6-2"><span class="toc-number">1.6.1.</span> <span class="toc-text">æ¡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%88%E6%9E%9C-3"><span class="toc-number">1.6.2.</span> <span class="toc-text">æ•ˆæœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81-4"><span class="toc-number">1.6.3.</span> <span class="toc-text">ç›¸å…³ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81-4"><span class="toc-number">1.6.4.</span> <span class="toc-text">å…³é”®ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F-3"><span class="toc-number">1.6.5.</span> <span class="toc-text">æ³¨æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-5"><span class="toc-number">1.6.6.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c07eff46.html" title="ã€Game.06ã€‘2022 DASCTF MAY å‡ºé¢˜äººæŒ‘æˆ˜èµ› Writeup"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220523123857608.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€Game.06ã€‘2022 DASCTF MAY å‡ºé¢˜äººæŒ‘æˆ˜èµ› Writeup"/></a><div class="content"><a class="title" href="/posts/c07eff46.html" title="ã€Game.06ã€‘2022 DASCTF MAY å‡ºé¢˜äººæŒ‘æˆ˜èµ› Writeup">ã€Game.06ã€‘2022 DASCTF MAY å‡ºé¢˜äººæŒ‘æˆ˜èµ› Writeup</a><time datetime="2022-05-23T04:31:49.000Z" title="å‘è¡¨äº 2022-05-23 12:31:49">2022-05-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/13285c73.html" title="ã€EP.02ã€‘_IO_FILE è‰ºæœ¯é‰´èµ"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/wallhaven-y8ogmx.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€EP.02ã€‘_IO_FILE è‰ºæœ¯é‰´èµ"/></a><div class="content"><a class="title" href="/posts/13285c73.html" title="ã€EP.02ã€‘_IO_FILE è‰ºæœ¯é‰´èµ">ã€EP.02ã€‘_IO_FILE è‰ºæœ¯é‰´èµ</a><time datetime="2022-05-18T08:41:00.000Z" title="å‘è¡¨äº 2022-05-18 16:41:00">2022-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ab2b6a2b.html" title="ã€EP.01ã€‘shellcode è‰ºæœ¯é‰´èµ"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/91458.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€EP.01ã€‘shellcode è‰ºæœ¯é‰´èµ"/></a><div class="content"><a class="title" href="/posts/ab2b6a2b.html" title="ã€EP.01ã€‘shellcode è‰ºæœ¯é‰´èµ">ã€EP.01ã€‘shellcode è‰ºæœ¯é‰´èµ</a><time datetime="2022-05-06T13:11:49.000Z" title="å‘è¡¨äº 2022-05-06 21:11:49">2022-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d6d32804.html" title="ã€Heap.05ã€‘Glibc 2.32 ä»¥ä¸Šçš„æŒ‡é’ˆå¼‚æˆ–åŠ å¯†æœºåˆ¶è¯¦è§£ä»¥åŠä¿©é“ä¾‹é¢˜"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/wallhaven-76dg8y.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€Heap.05ã€‘Glibc 2.32 ä»¥ä¸Šçš„æŒ‡é’ˆå¼‚æˆ–åŠ å¯†æœºåˆ¶è¯¦è§£ä»¥åŠä¿©é“ä¾‹é¢˜"/></a><div class="content"><a class="title" href="/posts/d6d32804.html" title="ã€Heap.05ã€‘Glibc 2.32 ä»¥ä¸Šçš„æŒ‡é’ˆå¼‚æˆ–åŠ å¯†æœºåˆ¶è¯¦è§£ä»¥åŠä¿©é“ä¾‹é¢˜">ã€Heap.05ã€‘Glibc 2.32 ä»¥ä¸Šçš„æŒ‡é’ˆå¼‚æˆ–åŠ å¯†æœºåˆ¶è¯¦è§£ä»¥åŠä¿©é“ä¾‹é¢˜</a><time datetime="2022-05-03T15:01:40.000Z" title="å‘è¡¨äº 2022-05-03 23:01:40">2022-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d80f8624.html" title="ã€Game.05ã€‘2022 ä¸­å›½æµ·æ´‹å¤§å­¦æ ¡èµ› Writeup"><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220502142421555.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ã€Game.05ã€‘2022 ä¸­å›½æµ·æ´‹å¤§å­¦æ ¡èµ› Writeup"/></a><div class="content"><a class="title" href="/posts/d80f8624.html" title="ã€Game.05ã€‘2022 ä¸­å›½æµ·æ´‹å¤§å­¦æ ¡èµ› Writeup">ã€Game.05ã€‘2022 ä¸­å›½æµ·æ´‹å¤§å­¦æ ¡èµ› Writeup</a><time datetime="2022-05-02T13:05:03.000Z" title="å‘è¡¨äº 2022-05-02 21:05:03">2022-05-02</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2022 By uuu</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">è¢«è¿™è¯ / æ¬ºéª—çš„ / ä½•æ­¢ä½ æˆ‘</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'f8c1aa5156a51043b92c',
      clientSecret: '2dbd19fe6377d79a5f1af0d87db7c177c1e51c49',
      repo: 'caffelne.github.io',
      owner: 'caffelne',
      admin: ['caffelne'],
      id: '37527fa715ad798e9b081b0fe322aede',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>